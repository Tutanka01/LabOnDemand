<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LabOnDemand - Dashboard</title>    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="css/lab-status.css">
    <link rel="stylesheet" href="css/app-status.css">
    <link rel="stylesheet" href="css/quotas.css">
    <!-- xterm.js CSS pour le terminal web -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/xterm/css/xterm.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- Ajout de Font Awesome pour les icônes -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">    <!-- Charger les scripts au format module -->
    <!-- xterm.js pour terminal intégré (chargé globalement AVANT les modules) -->
    <script src="https://cdn.jsdelivr.net/npm/xterm/lib/xterm.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xterm-addon-fit/lib/xterm-addon-fit.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xterm-addon-attach/lib/xterm-addon-attach.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xterm-addon-webgl/lib/xterm-addon-webgl.min.js"></script>
    <script type="module" src="index-auth.js"></script>
    <script type="module" src="script.js"></script>
</head>
<body>    <header>
        <div class="container header-content">
            <div class="logo">
                <i class="fas fa-cubes logo-icon"></i> <!-- Icône simple pour le logo -->
                LabOnDemand
            </div>
            <div class="user-info">
                <span id="api-status">Vérification de l'API...</span>
                <span id="user-greeting">Chargement... <i class="fas fa-user-circle"></i></span>
                <button id="logout-btn" class="logout-btn"><i class="fas fa-sign-out-alt"></i> Déconnexion</button>
            </div>
        </div>
    </header>

    <main class="container">
        <!-- Section Dashboard Principal -->
        <section id="dashboard-view" class="view active-view">
            <div class="dashboard-hero">
                <div class="hero-left">
                    <h1>Laboratoires prêts en un clic</h1>
                    <p class="hero-subtitle">Pilotez vos environnements Kubernetes, retrouvez vos fichiers et gardez une vue claire sur vos ressources.</p>
                    <div class="hero-actions">
                        <button id="show-launch-view-btn" class="btn btn-primary btn-hero">
                            <i class="fas fa-plus-circle"></i> Lancer une application
                        </button>
                        <button id="refresh-dashboard" class="btn btn-ghost btn-hero">
                            <i class="fas fa-sync-alt"></i> Rafraîchir le tableau
                        </button>
                    </div>
                </div>
                <div class="hero-stats">
                    <div class="hero-stat">
                        <span class="stat-label">Apps actives</span>
                        <span class="stat-value" id="stat-active-apps">0</span>
                    </div>
                    <div class="hero-stat">
                        <span class="stat-label">Apps prêtes</span>
                        <span class="stat-value" id="stat-ready-apps">0</span>
                    </div>
                    <div class="hero-stat">
                        <span class="stat-label">Volumes gérés</span>
                        <span class="stat-value" id="stat-persistent-volumes">0</span>
                    </div>
                    <div class="hero-stat">
                        <span class="stat-label">Apps restantes</span>
                        <span class="stat-value" id="stat-quota-apps">—</span>
                    </div>
                </div>
            </div>

            <div class="dashboard-grid">
                <div class="card glass-card quotas-card" id="my-quotas-card">
                    <div class="quotas-header">
                        <h2><i class="fas fa-gauge-high"></i> Vos ressources</h2>
                        <button id="refresh-quotas" class="btn btn-secondary btn-sm"><i class="fas fa-sync-alt"></i> Rafraîchir</button>
                    </div>
                    <div id="quotas-content" class="quotas-content">Chargement...</div>
                </div>

                <div class="card glass-card tips-card">
                    <h2><i class="fas fa-lightbulb"></i> Astuces express</h2>
                    <ul class="tips-list">
                        <li><i class="fas fa-rotate"></i> Actualisez après un arrêt ou une création pour mettre à jour les stats.</li>
                        <li><i class="fas fa-database"></i> Renommez vos déploiements pour identifier facilement les volumes associés.</li>
                        <li><i class="fas fa-shield-alt"></i> Les volumes LabOnDemand sont isolés par utilisateur et vérifiés côté API.</li>
                    </ul>
                </div>

                <div class="card glass-card pvc-quick-card" id="pvc-quick-card">
                    <h2><i class="fas fa-hdd"></i> Volumes persistants</h2>
                    <div class="pvc-quick-stats">
                        <div class="pvc-stat-item">
                            <span class="pvc-stat-value" id="pvc-stat-total">—</span>
                            <span class="pvc-stat-label">Total</span>
                        </div>
                        <div class="pvc-stat-item">
                            <span class="pvc-stat-value bound" id="pvc-stat-bound">—</span>
                            <span class="pvc-stat-label">Attachés</span>
                        </div>
                    </div>
                    <button id="show-pvc-panel-btn" class="btn btn-secondary btn-block">
                        <i class="fas fa-list"></i> Voir tous les volumes
                    </button>
                    <p class="pvc-hint"><i class="fas fa-info-circle"></i> Sélectionnez un volume lors du lancement VS Code ou Jupyter.</p>
                </div>
            </div>

            <div class="section-heading">
                <div>
                    <h2><i class="fas fa-rocket"></i> Applications Actives</h2>
                    <p class="section-subtitle">Surveillez l’état de vos laboratoires en direct et accédez-y en un clic.</p>
                </div>
            </div>
            <div id="active-labs-list" class="card-grid lab-grid">
                <!-- Les labs actifs seront ajoutés ici par JS -->
                <div class="no-labs-message">
                    <i class="fas fa-info-circle"></i> Vous n'avez aucune application active pour le moment.
                </div>
            </div>

            <!-- Section PVC détaillée déplaçable en bas -->
            <div class="collapsible-section pvc-section">
                <div class="collapsible-header" id="pvc-section-toggle">
                    <h2><i class="fas fa-hdd"></i> Mes volumes persistants</h2>
                    <i class="fas fa-chevron-down toggle-icon"></i>
                </div>
                <div id="pvc-resources" class="collapsible-content">
                    <div class="pvc-panel-actions">
                        <button id="refresh-pvcs" class="btn btn-secondary btn-sm"><i class="fas fa-sync-alt"></i> Rafraîchir</button>
                    </div>
                    <div id="pvc-list" class="pvc-list">Chargement...</div>
                </div>
            </div>
            
            <!-- Section pour les listes Kubernetes (masquée par défaut) -->
            <div class="collapsible-section">
                <div class="collapsible-header" id="k8s-section-toggle">
                    <h2><i class="fas fa-server"></i> Informations Kubernetes</h2>
                    <i class="fas fa-chevron-down toggle-icon"></i>
                </div>
                <div id="k8s-resources" class="collapsible-content k8s-section">
                    <div class="k8s-resource-panel" id="admin-pvc-panel">
                        <div class="panel-header">
                            <h3><i class="fas fa-database"></i> Volumes persistants (LabOnDemand)</h3>
                            <div class="action-buttons">
                                <button id="refresh-admin-pvcs" class="btn btn-secondary btn-sm"><i class="fas fa-sync-alt"></i> Rafraîchir</button>
                            </div>
                        </div>
                        <div id="admin-pvcs-list">Chargement...</div>
                    </div>

                    <div class="k8s-resource-panel">
                        <h3><i class="fas fa-project-diagram"></i> Namespaces</h3>
                        <div id="namespaces-list">Chargement...</div>
                    </div>
                    
                    <div class="k8s-resource-panel">
                        <h3><i class="fas fa-cube"></i> Pods</h3>
                        <div class="action-buttons">
                            <button id="refresh-pods" class="btn btn-secondary"><i class="fas fa-sync-alt"></i> Rafraîchir</button>
                        </div>
                        <div id="pods-list">Chargement...</div>
                    </div>
                    
                    <div class="k8s-resource-panel">
                        <h3><i class="fas fa-layer-group"></i> Déploiements</h3>
                        <div class="action-buttons">
                            <button id="refresh-deployments" class="btn btn-secondary"><i class="fas fa-sync-alt"></i> Rafraîchir</button>
                        </div>
                        <div id="deployments-list">Chargement...</div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Section Catalogue pour Lancer -->
        <section id="launch-view" class="view">
            <button class="btn btn-secondary back-btn" data-target="dashboard-view"><i class="fas fa-arrow-left"></i> Retour</button>
            <h1><i class="fas fa-th-large"></i> Choisir une Application</h1>
            <p class="subtitle">Sélectionnez l'application que vous souhaitez lancer.</p>
            <div class="catalog-toolbar card">
                <div class="toolbar-row">
                    <div class="search-box">
                        <i class="fas fa-search"></i>
                        <input type="text" id="catalog-search" placeholder="Rechercher une application...">
                    </div>
                    <div class="tag-filters" id="tag-filters">
                        <!-- Tags dynamiquement ajoutés -->
                    </div>
                </div>
            </div>
            <div class="card-grid service-catalog" id="service-catalog">
                <!-- Rempli dynamiquement depuis /api/v1/k8s/templates -->
            </div>
        </section>

        <!-- Section Configuration (Modale ou vue dédiée) -->
        <section id="config-view" class="view">
             <button class="btn btn-secondary back-btn" data-target="launch-view"><i class="fas fa-arrow-left"></i> Retour</button>
            <h1><i class="fas fa-cogs"></i> Configurer l'application <span id="config-service-name"></span></h1>
            <p class="subtitle">Ajustez les paramètres de votre nouvelle application.</p>

            <form id="config-form" class="config-form card">
                <input type="hidden" id="service-type" value="">
                <input type="hidden" id="service-icon-class" value="">
                <input type="hidden" id="deployment-type" value="">

                <div class="form-group">
                    <label for="deployment-name"><i class="fas fa-tag"></i> Nom du déploiement</label>
                    <input type="text" id="deployment-name" name="deployment-name" required placeholder="Entrez un nom unique">
                    <small>Ce nom sera utilisé pour identifier votre application</small>
                </div>

                <!-- Le namespace est désormais géré côté serveur (un par utilisateur) -->

                <div class="form-group">
                    <label for="cpu"><i class="fas fa-microchip"></i> Processeur (vCPU)</label>
                     <select id="cpu" name="cpu">
                        <option value="very-low">0.1 vCPU (Très faible)</option>
                        <option value="low">0.25 vCPU (Faible)</option>
                        <option value="medium" selected>0.5 vCPU (Standard)</option>
                        <option value="high">1 vCPU (Performant)</option>
                        <option value="very-high">2 vCPU (Très performant)</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="ram"><i class="fas fa-memory"></i> Mémoire (RAM)</label>
                     <select id="ram" name="ram">
                        <option value="very-low">128 Mi (Très faible)</option>
                        <option value="low">256 Mi (Faible)</option>
                        <option value="medium" selected>512 Mi (Standard)</option>
                        <option value="high">1 Gi (Performant)</option>
                        <option value="very-high">2 Gi (Très performant)</option>
                    </select>
                </div>

                <!-- Options spécifiques pour les déploiements personnalisés -->
                <div id="custom-deployment-options" style="display: none;">
                    <div class="form-group">
                        <label for="deployment-image"><i class="fas fa-box"></i> Image Docker</label>
                        <input type="text" id="deployment-image" name="deployment-image" value="nginx">
                        <small>Image Docker à déployer (ex: nginx, postgres:13, etc.)</small>
                    </div>
                    
                    <div class="form-group">
                        <label for="deployment-replicas"><i class="fas fa-copy"></i> Nombre de réplicas</label>
                        <input type="number" id="deployment-replicas" name="deployment-replicas" value="1" min="1">
                        <small>Nombre d'instances à déployer</small>
                    </div>
                    
                    <div class="form-group service-config">
                        <label class="checkbox-label">
                            <input type="checkbox" id="create-service" checked>
                            Exposer l'application (création d'un Service Kubernetes)
                        </label>
                        <p><a href="#" id="advanced-options-toggle">Options réseau avancées</a></p>
                        <div id="service-options" style="display:none;">
                            <div class="form-group">
                                <label for="service-type-select"><i class="fas fa-network-wired"></i> Mode d'accès</label>
                                <select id="service-type-select" name="service-type-select">
                                    <option value="ClusterIP">ClusterIP (interne)</option>
                                    <option value="NodePort" selected>NodePort (accès externe)</option>
                                    <option value="LoadBalancer">LoadBalancer (avec équilibrage)</option>
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label for="service-port"><i class="fas fa-plug"></i> Port d'accès</label>
                                <input type="number" id="service-port" name="service-port" value="80" min="1" max="65535">
                                <small>Port externe sur lequel l'application sera accessible</small>
                            </div>
                            
                            <div class="form-group">
                                <label for="service-target-port"><i class="fas fa-bullseye"></i> Port de l'application (container)</label>
                                <input type="number" id="service-target-port" name="service-target-port" value="80" min="1" max="65535">
                                <small>Port sur lequel l'application écoute dans le container</small>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="form-group dataset-group" id="jupyter-options" style="display: none;"> <!-- Options spécifiques Jupyter -->
                    <label><i class="fas fa-database"></i> Datasets à inclure</label>
                    <div class="checkbox-group">
                        <label><input type="checkbox" name="dataset" value="TP1_Data"> Données TP1</label>
                        <label><input type="checkbox" name="dataset" value="Projet_Stats"> Données Projet Stats</label>
                        <label><input type="checkbox" name="dataset" value="Demo_Images"> Images Démo</label>
                    </div>
                </div>

                <div class="form-group" id="persistent-volume-group" style="display: none;">
                    <label for="existing-pvc-select"><i class="fas fa-hdd"></i> Volume persistant</label>
                    <select id="existing-pvc-select">
                        <option value="">Créer un nouveau volume</option>
                    </select>
                    <small>Réutilisez un volume existant pour retrouver vos fichiers.</small>
                </div>

                <div class="form-actions">
                    <button type="submit" class="btn btn-primary btn-launch">
                        <i class="fas fa-rocket"></i> Lancer l'Application
                    </button>
                </div>
            </form>
        </section>

        <!-- Section Statut / Confirmation -->
        <section id="status-view" class="view">
            <div id="status-content" class="card status-card">
                <!-- Contenu injecté par JS -->
            </div>
            <div class="status-actions">
                <button class="btn btn-secondary back-btn" data-target="dashboard-view"><i class="fas fa-check-circle"></i> Terminé</button>
            </div>
        </section>

        <!-- Modales pour les opérations K8s -->
        <div class="modal" id="delete-modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>Confirmer la suppression</h3>
                    <span class="close-modal">&times;</span>
                </div>
                <div class="modal-body">
                    <p>Êtes-vous sûr de vouloir supprimer cet élément?</p>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" id="cancel-delete">Annuler</button>
                    <button class="btn btn-danger" id="confirm-delete">Supprimer</button>
                </div>
            </div>
        </div>
        
        <div class="modal" id="deployment-details-modal">
            <div class="modal-content modal-lg">
                <div class="modal-header">
                    <h3>Détails du déploiement</h3>
                    <span class="close-modal">&times;</span>
                </div>
                <div class="modal-body" id="deployment-details-content">
                    <div class="loading-spinner">
                        <i class="fas fa-spinner fa-spin"></i>
                        <p>Chargement des détails...</p>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary close-modal-btn">Fermer</button>
                </div>
            </div>
        </div>

        <div class="modal" id="novnc-modal">
            <div class="modal-content modal-novnc">
                <div class="modal-header">
                    <h3 id="novnc-modal-title"><i class="fas fa-desktop"></i> Session NoVNC</h3>
                    <span class="close-modal">&times;</span>
                </div>
                <div class="modal-body novnc-modal-body">
                    <div id="novnc-status" class="novnc-status-banner">
                        <i class="fas fa-circle-notch fa-spin"></i> Préparation de la session NoVNC...
                    </div>
                    <div id="novnc-credentials" class="novnc-credentials"></div>
                    <iframe id="novnc-frame" class="novnc-frame" title="Client NoVNC intégré" allowfullscreen allow="clipboard-read; clipboard-write; fullscreen"></iframe>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary close-modal-btn"><i class="fas fa-times-circle"></i> Fermer</button>
                </div>
            </div>
        </div>
    </main>

    <footer>
        <div class="container">
            © 2025 LabOnDemand - Université de Pau et des Pays de l'Adour
        </div>    </footer>

    <!-- Le script principal (script.js) est chargé dynamiquement par index-auth.js -->
</body>
</html>